{% extends 'base_app.html' %}

{% block title %}Novo {{ category_singular }} - LumaVet{% endblock %}
{% block page_title %}Novo {{ category_singular }}{% endblock %}

{% block main_content %}
<div class="card">
    <h2 class="card-title">Cadastrar {{ category_singular }}</h2>

    <form method="post" class="exam-upload-form">
        {% csrf_token %}

        {% for field in form %}
            <div class="profile-form-row">
                <div class="profile-form-group" style="grid-column: 1 / -1;">
                    {% if category == 'pets' and field.name == 'tutor' %}
                        <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                        <input type="text" id="tutor-search"
                               placeholder="Digite para filtrar tutores..."
                               style="margin-bottom: 6px;">
                        {{ field }}
                    {% else %}
                        <label for="{{ field.id_for_label }}">{{ field.label }}:</label>
                        {{ field }}
                    {% endif %}
                    {% if field.errors %}
                        <div class="field-error">{{ field.errors.0 }}</div>
                    {% endif %}
                    {% if field.help_text %}
                      <div class="field-hint">{{ field.help_text }}</div>
                    {% endif %}
                </div>
            </div>
        {% endfor %}

        <button type="submit" class="btn-primary">Salvar</button>
        <a href="{% url 'gestao_category' category %}" style="margin-left: 10px; font-size: 13px;">Cancelar</a>
    </form>
</div>
{% if category == 'pets' %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const searchInput = document.getElementById('tutor-search');
    const select = document.getElementById('id_tutor');

    if (!searchInput || !select) return;

    searchInput.addEventListener('input', function () {
        const term = this.value.toLowerCase();

        for (let i = 0; i < select.options.length; i++) {
            const option = select.options[i];

            // Mantém a opção vazia (---------) sempre visível
            if (option.value === "") {
                option.hidden = false;
                continue;
            }

            const text = option.text.toLowerCase();
            option.hidden = term && !text.includes(term);
        }
    });
});
</script>
{% endif %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const phoneInput = document.getElementById('id_phone');
    if (!phoneInput) return;

    phoneInput.addEventListener('input', function () {
        let digits = phoneInput.value.replace(/\D/g, '');

        if (digits.length > 11) digits = digits.slice(0, 11);

        if (!digits) {
            phoneInput.value = '';
            return;
        }

        let result = '(' + digits.slice(0, 2);
        if (digits.length <= 2) {
            phoneInput.value = result;
            return;
        }

        result += ') ';
        let rest = digits.slice(2);

        if (rest.length <= 4) {
            result += rest;
        } else {
            result += rest.slice(0, rest.length - 4) + '-' + rest.slice(-4);
        }

        phoneInput.value = result;
    });
});
</script>
{% endblock %}

