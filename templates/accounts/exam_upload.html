{% extends 'base_app.html' %}
{% load static %}

{% block title %}Novo exame - LumaVet{% endblock %}
{% block page_title %}Novo exame{% endblock %}

{% block main_content %}
<div class="card">
    <h2 class="card-title">Cadastrar novo exame</h2>

    {% if form.non_field_errors %}
        <div class="messages">
            <div class="message-error">
                {{ form.non_field_errors.0 }}
            </div>
        </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="exam-upload-form">
        {% csrf_token %}

        <!-- PRIMEIRA LINHA: Clínica / Vet + Arquivo PDF -->
        <div class="profile-form-row">
            <div class="profile-form-group">
                <label for="{{ form.clinic_or_vet.id_for_label }}">Clínica / Veterinário:</label>
                {{ form.clinic_or_vet }}
                {% if form.clinic_or_vet.errors %}
                    <div class="field-error">{{ form.clinic_or_vet.errors.0 }}</div>
                {% endif %}
            </div>

            <div class="profile-form-group">
                <label for="{{ form.pdf_file.id_for_label }}">Arquivo PDF:</label>

                <div class="file-picker">
                    {{ form.pdf_file }}
                    <button type="button" class="btn-file" id="main-pdf-btn">Selecionar PDF</button>
                    <span class="file-count" id="main-pdf-name">Nenhum arquivo selecionado</span>
                </div>

                {% if form.pdf_file.errors %}
                    <div class="field-error">{{ form.pdf_file.errors.0 }}</div>
                {% endif %}

                <div class="field-hint">
                    Formato do nome:
                    <strong>Laudo Pet Raça Tutor Exame DD.MM.YYYY.pdf</strong>
                    <br>
                    Exemplo:
                    <strong>Laudo Rex Labrador Gustavo_Silva Ultrassonografia 31.12.2025.pdf</strong>
                </div>
            </div>
        </div>


        <!-- CAMPOS OPCIONAIS (SUSPENSO) -->
        <details class="optional-fields">
          <summary class="optional-fields-summary">
            Preencher campos opcionais
          </summary>

          <div class="optional-fields-body">
            <!-- Celular + E-mail -->
            <div class="profile-form-row" style="margin-top: 12px;">
              <div class="profile-form-group">
                <label for="{{ form.tutor_phone.id_for_label }}">Celular Tutor:</label>
                {{ form.tutor_phone }}
                {% if form.tutor_phone.errors %}
                  <div class="field-error">{{ form.tutor_phone.errors.0 }}</div>
                {% endif %}
                <div class="field-hint">
                  Formato: (XX) 9XXXX-XXXX ou (XX) XXXX-XXXX
                </div>
              </div>

              <div class="profile-form-group">
                <label for="{{ form.tutor_email.id_for_label }}">E-mail Tutor:</label>
                {{ form.tutor_email }}
                {% if form.tutor_email.errors %}
                  <div class="field-error">{{ form.tutor_email.errors.0 }}</div>
                {% endif %}
              </div>
            </div>
            
            <!-- PDFs extras (linha inteira) -->
            <div class="profile-form-row">
              <div class="profile-form-group" style="grid-column: 1 / -1;">
                <label for="{{ form.extra_pdfs.id_for_label }}">PDFs extras:</label>

                <div class="file-picker">
                  {{ form.extra_pdfs }}
                  <button type="button" class="btn-file" id="extra-pdfs-btn">Selecionar PDFs</button>
                  <span class="file-count" id="extra-pdfs-count">Nenhum arquivo selecionado</span>
                </div>

                <div id="extra-pdfs-list" class="file-list"></div>

                {% if form.extra_pdfs.errors %}
                  <div class="field-error">{{ form.extra_pdfs.errors.0 }}</div>
                {% endif %}

                <div class="field-hint">Aceita até 5 PDFs. Clique no nome do arquivo para remover.</div>
              </div>
            </div>

            <!-- Observações -->
            <div class="profile-form-row">
              <div class="profile-form-group" style="grid-column: 1 / -1;">
                <label for="{{ form.observations.id_for_label }}">Observações:</label>
                {{ form.observations }}
                {% if form.observations.errors %}
                  <div class="field-error">{{ form.observations.errors.0 }}</div>
                {% endif %}
              </div>
            </div>
          </div>
        </details>


        <!-- BOTÕES -->
        <button type="submit" class="btn-primary">Enviar exame</button>

        <a href="{% url 'exam_upload_multi' %}" style="margin-left: 10px; font-size: 13px;">
            Upload em massa
        </a>

        <a href="{% url 'exames' %}" style="margin-left: 10px; font-size: 13px;">
            Cancelar
        </a>
    </form>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const phoneInput = document.getElementById('id_tutor_phone');
    if (!phoneInput) return;

    phoneInput.addEventListener('input', function () {
        let digits = phoneInput.value.replace(/\D/g, '');

        // Limita a 11 dígitos (2 do DDD + 9 do número)
        if (digits.length > 11) {
            digits = digits.slice(0, 11);
        }

        if (!digits) {
            phoneInput.value = '';
            return;
        }

        let result = '(' + digits.slice(0, 2);
        if (digits.length <= 2) {
            phoneInput.value = result;
            return;
        }

        result += ') ';

        let rest = digits.slice(2);
        if (rest.length <= 4) {
            // ainda digitando, sem hífen
            result += rest;
        } else {
            // 4 ou 5 dígitos antes do hífen + 4 depois
            result += rest.slice(0, rest.length - 4) + '-' + rest.slice(-4);
        }

        phoneInput.value = result;
    });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  // --- PDF principal (1 arquivo) ---
  const mainInput = document.getElementById('id_pdf_file');
  const mainBtn = document.getElementById('main-pdf-btn');
  const mainName = document.getElementById('main-pdf-name');

  if (mainInput && mainBtn && mainName) {
    mainBtn.addEventListener('click', () => mainInput.click());

    mainInput.addEventListener('change', function () {
      if (mainInput.files && mainInput.files.length > 0) {
        mainName.textContent = mainInput.files[0].name;
      } else {
        mainName.textContent = 'Nenhum arquivo selecionado';
      }
    });
  }

  const input = document.getElementById('id_extra_pdfs');
  const btn = document.getElementById('extra-pdfs-btn');
  const count = document.getElementById('extra-pdfs-count');
  const list = document.getElementById('extra-pdfs-list');

  if (!input || !btn || !count || !list) return;

  const MAX_FILES = 5;
  const dt = new DataTransfer();

  function sameFile(a, b) {
    return a.name === b.name && a.size === b.size && a.lastModified === b.lastModified;
  }

  function updateInputFiles() {
    input.files = dt.files;
  }

  function render() {
    const files = Array.from(dt.files);

    if (files.length === 0) {
      count.textContent = 'Nenhum arquivo selecionado';
      list.innerHTML = '';
      return;
    }

    count.textContent = files.length === 1
      ? '1 arquivo selecionado'
      : `${files.length} arquivos selecionados`;

    const items = files.map((f, i) => (
      `<li><button type="button" class="file-remove" data-index="${i}" title="Remover">${f.name}</button></li>`
    )).join('');

    list.innerHTML = `<ul>${items}</ul>`;
  }

  btn.addEventListener('click', () => input.click());

  input.addEventListener('change', function () {
    const newFiles = Array.from(input.files || []);

    for (const f of newFiles) {
      // limite
      if (dt.files.length >= MAX_FILES) {
        alert(`Você pode anexar no máximo ${MAX_FILES} PDFs extras.`);
        break;
      }

      // evita duplicado (mesmo arquivo selecionado de novo)
      const already = Array.from(dt.files).some(existing => sameFile(existing, f));
      if (!already) dt.items.add(f);
    }

    updateInputFiles();
    render();

    // Importantíssimo: limpa o input pra permitir selecionar o mesmo arquivo novamente depois
    input.value = '';
  });

  list.addEventListener('click', function (e) {
    const btn = e.target.closest('.file-remove');
    if (!btn) return;

    const idx = Number(btn.getAttribute('data-index'));
    if (Number.isNaN(idx)) return;

    dt.items.remove(idx);
    updateInputFiles();
    render();
  });

  render();
});
</script>
{% endblock %}

