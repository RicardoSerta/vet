{% extends 'base_app.html' %}
{% load static %}

{% block title %}Novo exame - LumaVet{% endblock %}
{% block page_title %}Novo exame{% endblock %}

{% block main_content %}
<div class="card">
    <h2 class="card-title">Cadastrar novo exame</h2>

    {% if form.non_field_errors %}
        <div class="messages">
            <div class="message-error">
                {{ form.non_field_errors.0 }}
            </div>
        </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" class="exam-upload-form">
        {% csrf_token %}

        <!-- PRIMEIRA LINHA: Cl√≠nica / Vet + Arquivo PDF -->
        <div class="profile-form-row">
            <div class="profile-form-group">
                <label for="{{ form.clinic_or_vet.id_for_label }}">Cl√≠nica / Veterin√°rio:</label>
                {{ form.clinic_or_vet }}
                {% if form.clinic_or_vet.errors %}
                    <div class="field-error">{{ form.clinic_or_vet.errors.0 }}</div>
                {% endif %}
            </div>
            <div id="mainPdfDropZone" class="file-drop-zone">
                <div class="profile-form-group">
                    <label for="{{ form.pdf_file.id_for_label }}">Arquivo PDF:</label>

                    <div class="file-picker">
                        {{ form.pdf_file }}
                        <button type="button" class="btn-file" id="main-pdf-btn">Selecionar PDF</button>
                        <span class="file-count" id="main-pdf-name">Nenhum arquivo selecionado</span>
                    </div>

                    {% if form.pdf_file.errors %}
                        <div class="field-error">{{ form.pdf_file.errors.0 }}</div>
                    {% endif %}

                    <div class="field-hint">
                        Formato do nome:
                        <strong>Laudo Pet Ra√ßa Tutor Exame DD.MM.YYYY.pdf</strong>
                        <br>
                        Exemplo:
                        <strong>Laudo Rex Labrador Gustavo_Silva Ultrassonografia 31.12.2025.pdf</strong>
                    </div>
                </div>
            </div>
        </div>


        <!-- CAMPOS OPCIONAIS (SUSPENSO) -->
        <details class="optional-fields">
          <summary class="optional-fields-summary">
            Preencher campos opcionais
          </summary>

          <div class="optional-fields-body">
            <!-- Celular + E-mail -->
            <div class="profile-form-row" style="margin-top: 12px;">
              <div class="profile-form-group">
                <label for="{{ form.tutor_phone.id_for_label }}">Celular Tutor:</label>

                <div class="notify-input-wrap">
                  {{ form.tutor_phone }}
                  {{ form.notify_tutor_phone }}
                  <button type="button"
                          class="notify-bell notify-empty"
                          id="bell-tutor-phone"
                          title="Notificar via WhatsApp">üîî</button>
                </div>

                {% if form.tutor_phone.errors %}
                  <div class="field-error">{{ form.tutor_phone.errors.0 }}</div>
                {% endif %}
                <div class="field-hint">
                  Formato: (XX) 9XXXX-XXXX ou (XX) XXXX-XXXX
                </div>
              </div>

              <div class="profile-form-group">
                <label for="{{ form.tutor_email.id_for_label }}">E-mail Tutor:</label>

                <div class="notify-input-wrap">
                  {{ form.tutor_email }}
                  {{ form.notify_tutor_email }}
                  <button type="button"
                          class="notify-bell notify-empty"
                          id="bell-tutor-email"
                          title="Notificar via e-mail">üîî</button>
                </div>

                {% if form.tutor_email.errors %}
                  <div class="field-error">{{ form.tutor_email.errors.0 }}</div>
                {% endif %}
              </div>
            </div>
            
            <div class="profile-form-row" style="margin-top: 6px;">

              <!-- ESQUERDA: Adicionar cl√≠nicas/vets -->
              <div class="profile-form-group">
                <label for="{{ form.additional_clinic_or_vet.id_for_label }}">Adicionar Cl√≠nicas / Veterin√°rios:</label>

                <div class="file-picker">
                  <button type="button" class="btn-file" id="additional-cv-btn">Selecionar</button>
                  <span class="file-count" id="additional-cv-summary">Nenhum selecionado</span>
                </div>

                <div id="additional-cv-box" class="cv-hidden cv-box">
                  {{ form.additional_clinic_or_vet }}

                  <div class="cv-actions">
                    <button type="button" class="btn-primary cv-ok" id="additional-cv-ok">OK</button>
                    <button type="button" class="btn-link cv-clear" id="additional-cv-clear">Limpar</button>
                  </div>

                  <div class="field-hint">Selecione at√© 2 elementos.</div>
                </div>
              </div>

              <!-- DIREITA: Arquivos extras (mesmo conte√∫do que voc√™ j√° tinha, s√≥ removi o grid-column inline) -->
              <div id="extraFilesDropZone" class="profile-form-group file-drop-zone">
                <label for="{{ form.extra_files.id_for_label }}">Arquivos Extras:</label>

                <div class="file-picker">
                  {{ form.extra_files }}
                  <button type="button" class="btn-file" id="extra-files-btn">Selecionar Arquivos</button>
                  <span class="file-count" id="extra-files-count">Nenhum arquivo selecionado</span>
                </div>

                <div id="extra-files-list" class="file-list"></div>

                {% if form.extra_files.errors %}
                  <div class="field-error">{{ form.extra_files.errors.0 }}</div>
                {% endif %}

                <div class="field-hint">Aceita at√© 5 arquivos. Formatos: .pdf, .avi, .png, .jpg, .jpeg. Clique no nome do arquivo para remover.</div>
              </div>

            </div>

            <!-- Observa√ß√µes -->
            <div class="profile-form-row">
              <div class="profile-form-group" style="grid-column: 1 / -1;">
                <label for="{{ form.observations.id_for_label }}">Observa√ß√µes:</label>
                {{ form.observations }}
                {% if form.observations.errors %}
                  <div class="field-error">{{ form.observations.errors.0 }}</div>
                {% endif %}
              </div>
            </div>
          </div>
        </details>


        <!-- BOT√ïES -->
        <button type="submit" class="btn-primary">Enviar exame</button>

        <a href="{% url 'exam_upload_multi' %}" style="margin-left: 10px; font-size: 13px;">
            Upload em massa
        </a>

        <a href="{% url 'exames' %}" style="margin-left: 10px; font-size: 13px;">
            Cancelar
        </a>
    </form>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const phoneInput = document.getElementById('id_tutor_phone');
    if (!phoneInput) return;

    phoneInput.addEventListener('input', function () {
        let digits = phoneInput.value.replace(/\D/g, '');

        // Limita a 11 d√≠gitos (2 do DDD + 9 do n√∫mero)
        if (digits.length > 11) {
            digits = digits.slice(0, 11);
        }

        if (!digits) {
            phoneInput.value = '';
            return;
        }

        let result = '(' + digits.slice(0, 2);
        if (digits.length <= 2) {
            phoneInput.value = result;
            return;
        }

        result += ') ';

        let rest = digits.slice(2);
        if (rest.length <= 4) {
            // ainda digitando, sem h√≠fen
            result += rest;
        } else {
            // 4 ou 5 d√≠gitos antes do h√≠fen + 4 depois
            result += rest.slice(0, rest.length - 4) + '-' + rest.slice(-4);
        }

        phoneInput.value = result;
    });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {

  // ====== (NOVO) Helper de drag & drop ======
  function bindDropZone(zone, onFiles) {
    if (!zone) return;

    ["dragenter", "dragover"].forEach(evt => {
      zone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        zone.classList.add("dragover");
      });
    });

    ["dragleave", "drop"].forEach(evt => {
      zone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        zone.classList.remove("dragover");
      });
    });

    zone.addEventListener("drop", (e) => {
      const files = Array.from(e.dataTransfer?.files || []);
      if (files.length) onFiles(files);
    });
  }

  // --- PDF principal (1 arquivo) ---
  const mainInput = document.getElementById('id_pdf_file');
  const mainBtn = document.getElementById('main-pdf-btn');
  const mainName = document.getElementById('main-pdf-name');

  if (mainInput && mainBtn && mainName) {
    mainBtn.addEventListener('click', () => mainInput.click());

    mainInput.addEventListener('change', function () {
      if (mainInput.files && mainInput.files.length > 0) {
        mainName.textContent = mainInput.files[0].name;
      } else {
        mainName.textContent = 'Nenhum arquivo selecionado';
      }
    });

    // ====== (NOVO) Drag & drop no PDF principal ======
    const mainZone = document.getElementById('mainPdfDropZone');
    bindDropZone(mainZone, (files) => {
      const f = files[0]; // s√≥ 1
      const dtMain = new DataTransfer();
      dtMain.items.add(f);
      mainInput.files = dtMain.files;
      mainInput.dispatchEvent(new Event("change", { bubbles: true }));
    });
  }

    // --- Arquivos extras (at√© 5) ---
  const input = document.getElementById('id_extra_files'); // input REAL (o que o Django envia)
  const btn = document.getElementById('extra-files-btn');
  const count = document.getElementById('extra-files-count');
  const list = document.getElementById('extra-files-list');

  if (!input || !btn || !count || !list) return;

  const MAX_FILES = 5;
  const dt = new DataTransfer();
  const ALLOWED_EXTS = ['.pdf', '.avi', '.png', '.jpg', '.jpeg'];

  function hasAllowedExtension(file) {
    const name = (file.name || '').toLowerCase();
    return ALLOWED_EXTS.some(ext => name.endsWith(ext));
  }

  function sameFile(a, b) {
    return a.name === b.name && a.size === b.size && a.lastModified === b.lastModified;
  }

  function updateInputFiles() {
    // garante que o Django receba os arquivos no POST
    input.files = dt.files;
  }

  function render() {
    const files = Array.from(dt.files);

    if (files.length === 0) {
      count.textContent = 'Nenhum arquivo selecionado';
      list.innerHTML = '';
      return;
    }

    count.textContent = files.length === 1
      ? '1 arquivo selecionado'
      : `${files.length} arquivos selecionados`;

    const items = files.map((f, i) => (
      `<li><button type="button" class="file-remove" data-index="${i}" title="Remover">${f.name}</button></li>`
    )).join('');

    list.innerHTML = `<ul>${items}</ul>`;
  }

  // IMPORTANTE:
  // N√£o usamos o input real como seletor (input.click()), porque alguns navegadores
  // ‚Äúse perdem‚Äù quando o JS mexe em input.files e isso pode fazer o Django receber vazio.
  // Ent√£o usamos um input TEMPOR√ÅRIO s√≥ para escolher arquivos.
  btn.addEventListener('click', () => {
    const picker = document.createElement('input');
    picker.type = 'file';
    picker.multiple = true;
    picker.accept = input.getAttribute('accept') || '';
    picker.style.display = 'none';
    document.body.appendChild(picker);

    picker.addEventListener('change', () => {
      addFilesToExtras(Array.from(picker.files || []));
      picker.remove();
    }, { once: true });

    picker.click();
  });

  function addFilesToExtras(newFiles) {
    const invalid = [];

    for (const f of newFiles) {
      if (dt.files.length >= MAX_FILES) {
        alert(`Voc√™ pode anexar no m√°ximo ${MAX_FILES} arquivos extras.`);
        break;
      }

      if (!hasAllowedExtension(f)) {
        invalid.push(f.name);
        continue;
      }

      const already = Array.from(dt.files).some(existing => sameFile(existing, f));
      if (!already) dt.items.add(f);
    }

    updateInputFiles();
    render();

    if (invalid.length) {
      alert(
        'Alguns arquivos foram ignorados por formato inv√°lido:\n' +
        invalid.join('\n') +
        `\n\nFormatos aceitos: ${ALLOWED_EXTS.join(', ')}`
      );
    }
  }

  // remover arquivo ao clicar no nome
  list.addEventListener('click', function (e) {
    const b = e.target.closest('.file-remove');
    if (!b) return;

    const idx = Number(b.getAttribute('data-index'));
    if (Number.isNaN(idx)) return;

    dt.items.remove(idx);
    updateInputFiles();
    render();
  });

  // Drag & drop nos arquivos extras
  const extraZone = document.getElementById('extraFilesDropZone');
  bindDropZone(extraZone, (files) => {
    addFilesToExtras(files);
  });

  render();
});
</script>
<script>
(function () {
  const btn = document.getElementById("additional-cv-btn");
  const ok = document.getElementById("additional-cv-ok");
  const clear = document.getElementById("additional-cv-clear");
  const box = document.getElementById("additional-cv-box");
  const sel = document.getElementById("id_additional_clinic_or_vet");
  const summary = document.getElementById("additional-cv-summary");

  const mainSel = document.getElementById("id_clinic_or_vet");

  if (!btn || !box || !sel || !summary || !mainSel) return;

  // ordem de sele√ß√£o (pra remover o "mais antigo" ao escolher o 3¬∫)
  const order = [];

  // guarda todas as op√ß√µes originais (pra reativar quando trocar principal)
  const allOptions = Array.from(sel.options);

  function updateSummary() {
    const texts = Array.from(sel.selectedOptions).map(o => (o.textContent || "").trim());
    summary.textContent = texts.length ? texts.join(" + ") : "Nenhum selecionado";
  }

  function removeFromOrder(value) {
    const idx = order.indexOf(value);
    if (idx >= 0) order.splice(idx, 1);
  }

  function setSelected(value, on) {
    const opt = allOptions.find(o => o.value === value);
    if (opt) opt.selected = on;
  }

  function disableAdditionalOption(valueToDisable) {
    allOptions.forEach(opt => {
      if (!opt.value) return;
      const shouldDisable = opt.value === valueToDisable;

      // reabilita tudo primeiro; depois desabilita apenas o principal atual
      // (essa fun√ß√£o ser√° chamada ap√≥s a gente reabilitar globalmente)
      if (shouldDisable) {
        opt.disabled = true;
        opt.hidden = true; // some da lista
        // se estava selecionado, desmarca
        if (opt.selected) {
          opt.selected = false;
          removeFromOrder(opt.value);
        }
      }
    });
  }

  function enableAllAdditionalOptions() {
    allOptions.forEach(opt => {
      if (!opt.value) return;
      opt.disabled = false;
      opt.hidden = false;
    });
  }

  function syncMainVsAdditional() {
    // 1) reabilita tudo
    enableAllAdditionalOptions();

    // 2) desabilita o principal atual
    const mainValue = (mainSel.value || "").trim();
    if (mainValue) {
      disableAdditionalOption(mainValue);
    }

    // 3) garante limite de 2 (caso algo tenha sido removido)
    const selected = Array.from(sel.selectedOptions);
    if (selected.length > 2) {
      for (let i = 2; i < selected.length; i++) {
        selected[i].selected = false;
        removeFromOrder(selected[i].value);
      }
    }

    updateSummary();
  }

  // abre/fecha caixa
  btn.addEventListener("click", () => {
    box.classList.toggle("cv-hidden");
    if (!box.classList.contains("cv-hidden")) {
      if (ok) ok.focus(); // evita ‚Äúhighlight‚Äù autom√°tico do primeiro item
    }
  });

  // OK fecha
  if (ok) {
    ok.addEventListener("click", () => {
      box.classList.add("cv-hidden");
      updateSummary();
    });
  }

  // limpar
  if (clear) {
    clear.addEventListener("click", () => {
      Array.from(sel.options).forEach(o => o.selected = false);
      order.length = 0;
      updateSummary();
    });
  }

  // sele√ß√£o sem Ctrl
  sel.addEventListener("mousedown", (e) => {
    const opt = e.target.closest("option");
    if (!opt || !opt.value || opt.disabled) return;

    e.preventDefault();

    const val = opt.value;

    if (opt.selected) {
      opt.selected = false;
      removeFromOrder(val);
    } else {
      if (order.length >= 2) {
        const oldest = order.shift();
        setSelected(oldest, false);
      }
      opt.selected = true;
      order.push(val);
    }

    updateSummary();
  });

  // quando muda o principal, sincroniza (remove do adicional / reativa o antigo)
  mainSel.addEventListener("change", () => {
    syncMainVsAdditional();
  });

  // inicial
  syncMainVsAdditional();
})();
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  function applyState(bell, state) {
    bell.classList.remove("notify-empty", "notify-enabled", "notify-disabled");
    bell.classList.add("notify-" + state);

    // opcional: troca √≠cone quando desativado
    bell.textContent = (state === "disabled") ? "üîï" : "üîî";
  }

  function classifyPhone(v) {
    v = (v || "").trim();
    if (!v) return "empty";
    if (/^\(\d{2}\)\s?9\d{4}-\d{4}$/.test(v)) return "whatsapp";
    if (/^\(\d{2}\)\s?\d{4}-\d{4}$/.test(v)) return "landline";
    return "invalid";
  }

  function syncPhone(input, hidden, bell) {
    const kind = classifyPhone(input.value);

    if (kind === "empty") {
      hidden.value = "0";
      bell.dataset.userToggled = "";
      applyState(bell, "empty");
      bell.title = "Notificar via WhatsApp";
      bell.dataset.eligible = "0";
      return;
    }

    if (kind === "invalid") {
      hidden.value = "0";
      bell.dataset.userToggled = "";
      applyState(bell, "empty");
      bell.title = "Celular inv√°lido.";
      bell.dataset.eligible = "0";
      return;
    }

    if (kind === "landline") {
      hidden.value = "0";
      bell.dataset.userToggled = "";
      applyState(bell, "empty");
      bell.title = "N√£o √© poss√≠vel enviar um alerta para este n√∫mero";
      bell.dataset.eligible = "0";
      return;
    }

    // whatsapp v√°lido
    bell.dataset.eligible = "1";
    bell.title = "Notificar via WhatsApp";

    if (!bell.dataset.userToggled) hidden.value = "1";
    applyState(bell, hidden.value === "1" ? "enabled" : "disabled");
  }

  function syncEmail(input, hidden, bell) {
    const v = (input.value || "").trim();

    if (!v) {
      hidden.value = "0";
      bell.dataset.userToggled = "";
      applyState(bell, "empty");
      bell.title = "Notificar via e-mail";
      bell.dataset.eligible = "0";
      return;
    }

    // usa a valida√ß√£o nativa do type=email
    const ok = input.checkValidity();
    if (!ok) {
      hidden.value = "0";
      bell.dataset.userToggled = "";
      applyState(bell, "empty");
      bell.title = "E-mail inv√°lido.";
      bell.dataset.eligible = "0";
      return;
    }

    bell.dataset.eligible = "1";
    bell.title = "Notificar via e-mail";

    if (!bell.dataset.userToggled) hidden.value = "1";
    applyState(bell, hidden.value === "1" ? "enabled" : "disabled");
  }

  function setupBell(inputId, hiddenId, bellId, syncFn) {
    const input = document.getElementById(inputId);
    const hidden = document.getElementById(hiddenId);
    const bell = document.getElementById(bellId);
    if (!input || !hidden || !bell) return;

    bell.addEventListener("click", function () {
      if (bell.dataset.eligible !== "1") return; // cinza = n√£o clic√°vel

      bell.dataset.userToggled = "1";
      hidden.value = (hidden.value === "1") ? "0" : "1";
      // re-sincroniza pra atualizar visual
      syncFn(input, hidden, bell);
    });

    input.addEventListener("input", () => syncFn(input, hidden, bell));
    syncFn(input, hidden, bell);
  }

  setupBell("id_tutor_phone", "id_notify_tutor_phone", "bell-tutor-phone", syncPhone);
  setupBell("id_tutor_email", "id_notify_tutor_email", "bell-tutor-email", syncEmail);
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const phone = document.getElementById("id_tutor_phone");
  const email = document.getElementById("id_tutor_email");

  if (phone) {
    phone.addEventListener("invalid", function () {
      if ((phone.value || "").trim()) {
        phone.setCustomValidity("Celular inv√°lido.");
      } else {
        phone.setCustomValidity("");
      }
    });
    phone.addEventListener("input", () => phone.setCustomValidity(""));
  }

  if (email) {
    email.addEventListener("invalid", function () {
      if ((email.value || "").trim()) {
        email.setCustomValidity("E-mail inv√°lido.");
      } else {
        email.setCustomValidity("");
      }
    });
    email.addEventListener("input", () => email.setCustomValidity(""));
  }
});
</script>
{% endblock %}

