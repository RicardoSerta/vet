{% extends 'base_app.html' %}
{% load static %}

{% block title %}Exames - LumaVet{% endblock %}
{% block page_title %}Exames{% endblock %}

{% block main_content %}

<div class="card">
    <div class="exams-header">
        <div class="exams-header-left">
            <h2 class="card-title">Lista de exames</h2>
        </div>

        <div class="exams-header-right">
            <form method="get" class="exams-search-form">
                <input type="text" name="q" placeholder="Buscar..."
                       value="{{ search_query|default_if_none:'' }}">
                <button type="submit">Buscar</button>
            </form>

            {% if is_admin %}
                <!-- Bot√£o novo: Tipos de Exames (fica entre Buscar e Novo Exame) -->
                <a href="{% url 'exam_types' %}" class="btn-siglas" style="margin-left: 10px; margin-right: 0px;">
                    Siglas
                </a>
                <a href="{% url 'exam_upload' %}" class="btn-primary btn-upload-exam" style="margin-left: 10px;">
                    + Novo Exame
                </a>
            {% endif %}
        </div>
    </div>

    <div class="table-wrapper">
        <table class="exams-table">
            <thead>
                <tr>
                    {% with qparam=search_query|default_if_none:'' %}
                    <th>
                        <a href="?order=realizacao&direction={% if order == 'realizacao' and direction == 'asc' %}desc{% else %}asc{% endif %}{% if qparam %}&q={{ qparam|urlencode }}{% endif %}">
                            Realiza√ß√£o
                            {% if order == 'realizacao' %}
                                {% if direction == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                            {% endif %}
                        </a>
                    </th>
                    <th>
                        <a href="?order=clinica&direction={% if order == 'clinica' and direction == 'asc' %}desc{% else %}asc{% endif %}{% if qparam %}&q={{ qparam|urlencode }}{% endif %}">
                            Cl√≠nica / Veterin√°rio
                            {% if order == 'clinica' %}
                                {% if direction == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                            {% endif %}
                        </a>
                    </th>
                    <th>
                        <a href="?order=exame&direction={% if order == 'exame' and direction == 'asc' %}desc{% else %}asc{% endif %}{% if qparam %}&q={{ qparam|urlencode }}{% endif %}">
                            Exame
                            {% if order == 'exame' %}
                                {% if direction == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                            {% endif %}
                        </a>
                    </th>
                    <th>
                        <a href="?order=pet&direction={% if order == 'pet' and direction == 'asc' %}desc{% else %}asc{% endif %}{% if qparam %}&q={{ qparam|urlencode }}{% endif %}">
                            Pet
                            {% if order == 'pet' %}
                                {% if direction == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                            {% endif %}
                        </a>
                    </th>
                    <th>
                        <a href="?order=raca&direction={% if order == 'raca' and direction == 'asc' %}desc{% else %}asc{% endif %}{% if qparam %}&q={{ qparam|urlencode }}{% endif %}">
                            Ra√ßa
                            {% if order == 'raca' %}
                                {% if direction == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                            {% endif %}
                        </a>
                    </th>
                    <th>
                        <a href="?order=tutor&direction={% if order == 'tutor' and direction == 'asc' %}desc{% else %}asc{% endif %}{% if qparam %}&q={{ qparam|urlencode }}{% endif %}">
                            Tutor
                            {% if order == 'tutor' %}
                                {% if direction == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                            {% endif %}
                        </a>
                    </th>
                    <th>Alerta Email</th>
                    <th>Alerta Zap</th>
                    <th>
                        <a href="?order=retorno&direction={% if order == 'retorno' and direction == 'asc' %}desc{% else %}asc{% endif %}{% if qparam %}&q={{ qparam|urlencode }}{% endif %}">
                            Retorno Previsto
                            {% if order == 'retorno' %}
                                {% if direction == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                            {% endif %}
                        </a>
                    </th>
                    <th>A√ß√µes</th>
                    {% endwith %}
                </tr>
            </thead>

            <tbody>
                {% if exams %}
                    {% for exam in exams %}
                        <tr>
                            <td>{{ exam.date_realizacao|date:"d/m/Y" }}</td>
                            <td>{{ exam.clinic_or_vet }}</td>
                            <td>{{ exam.exam_type }}</td>
                            <td>{{ exam.pet_name }}</td>
                            <td>{{ exam.breed }}</td>
                            <td>{{ exam.tutor_name }}</td>
                            <td>
                                {% if exam.alerta_email %}
                                    {{ exam.alerta_email|date:"d/m/Y H:i" }}
                                {% else %}
                                    ‚Äì
                                {% endif %}
                            </td>
                            <td>
                                {% if exam.alerta_zap %}
                                    {{ exam.alerta_zap|date:"d/m/Y H:i" }}
                                {% else %}
                                    ‚Äì
                                {% endif %}
                            </td>
                            <td>
                                {% if exam.retorno_previsto %}
                                    {{ exam.retorno_previsto|date:"d/m/Y" }}
                                {% else %}
                                    ‚Äì
                                {% endif %}
                            </td>

                            <td class="exams-actions">
                                {% if is_admin %}
                                  <a href="{% url 'exam_forward' exam.pk %}" title="Encaminhar" class="btn-icon btn-icon-blue">‚úâ</a>
                                {% endif %}

                                <a href="{% url 'exam_view' exam.pk %}" title="Visualizar exame" class="btn-icon btn-icon-green">üëÅ</a>

                                {% if is_admin %}
                                  <form method="post" action="{% url 'exam_delete' exam.pk %}" style="display:inline;">
                                      {% csrf_token %}
                                      <button type="submit" class="btn-icon btn-icon-red" title="Excluir"
                                          onclick="return confirm('Tem certeza que deseja excluir este exame?');">üóë</button>
                                  </form>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="10" style="text-align:center;">
                            Nenhum exame cadastrado ainda.
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

