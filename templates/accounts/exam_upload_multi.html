{% extends 'base_app.html' %}

{% block title %}Upload em massa - LumaVet{% endblock %}
{% block page_title %}Upload em massa{% endblock %}

{% block main_content %}
<div class="card">
    <h2 class="card-title">Fazer upload de vários exames</h2>

    <form method="post" enctype="multipart/form-data" class="exam-upload-form">
      {% csrf_token %}

      <!-- LINHA 1: CLÍNICA/VET (linha inteira) -->
      <div class="profile-form-row">
        <div class="profile-form-group" style="grid-column: 1 / -1;">
          <label for="{{ form.clinic_or_vet.id_for_label }}">Clínica / Veterinário:</label>
          {{ form.clinic_or_vet }}
          {% if form.clinic_or_vet.errors %}
            <div class="field-error">{{ form.clinic_or_vet.errors.0 }}</div>
          {% endif %}
        </div>
      </div>

      <!-- LINHA 2: PDFs (linha inteira) -->
      <div class="profile-form-row">
        <div id="multiPdfsDropZone" class="file-drop-zone">
          <div class="profile-form-group" style="grid-column: 1 / -1;">
            <label for="{{ form.pdf_files.id_for_label }}">Arquivos PDF:</label>

            <div class="file-picker">
              {{ form.pdf_files }}
              <button type="button" class="btn-file" id="multi-pdfs-btn">Selecionar PDFs</button>
              <span class="file-count" id="multi-pdfs-count">Nenhum arquivo selecionado</span>
            </div>

            <div id="multi-pdfs-list" class="file-list"></div>

            {% if form.pdf_files.errors %}
              <div class="field-error">{{ form.pdf_files.errors.0 }}</div>
            {% endif %}

            <div class="field-hint">
              Formato do nome: <strong>Laudo Pet Raça Tutor Exame DD.MM.YYYY.pdf</strong><br>
              Exemplo: <strong>Laudo Rex Labrador Gustavo_Silva Ultrassonografia 31.12.2025.pdf</strong><br>
              Você pode selecionar até 50 PDFs por vez. Clique no nome do arquivo para remover.
            </div>
          </div>
        </div>
      </div>

      <!-- BOTÕES (mais organizados) -->
      <div class="form-actions">
        <button type="submit" class="btn-primary">Enviar exames</button>
        <a href="{% url 'exam_upload' %}" class="btn-link">Voltar</a>
      </div>
    </form>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const fileInput = document.getElementById('id_pdf_files');
  const btn = document.getElementById('multi-pdfs-btn');
  const label = document.getElementById('multi-pdfs-count');
  const list = document.getElementById('multi-pdfs-list');
  const multiZone = document.getElementById('multiPdfsDropZone');

  if (!fileInput || !btn || !label || !list || !multiZone) return;

  const MAX_FILES = 50;
  let dt = new DataTransfer();

  function bindDropZone(zone, onFiles) {
    if (!zone) return;

    ["dragenter", "dragover"].forEach(evt => {
      zone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        zone.classList.add("dragover");
      });
    });

    ["dragleave", "drop"].forEach(evt => {
      zone.addEventListener(evt, (e) => {
        e.preventDefault();
        e.stopPropagation();
        zone.classList.remove("dragover");
      });
    });

    zone.addEventListener("drop", (e) => {
      const files = Array.from(e.dataTransfer?.files || []);
      if (files.length) onFiles(files);
    });
  }

  function syncAndRender() {
    fileInput.files = dt.files;
    render();
  }

  function render() {
    const count = dt.files.length;

    if (count === 0) {
      label.textContent = "Nenhum arquivo selecionado";
      list.innerHTML = "";
      return;
    }

    label.textContent = `${count} arquivo(s) selecionado(s)`;

    list.innerHTML = "<ul></ul>";
    const ul = list.querySelector("ul");

    Array.from(dt.files).forEach((f, idx) => {
      const li = document.createElement("li");

      const removeBtn = document.createElement("button");
      removeBtn.type = "button";
      removeBtn.className = "file-remove";
      removeBtn.textContent = f.name;
      removeBtn.title = "Clique para remover";

      removeBtn.addEventListener("click", () => {
        const newDt = new DataTransfer();
        Array.from(dt.files).forEach((file, i) => {
          if (i !== idx) newDt.items.add(file);
        });
        dt = newDt;
        syncAndRender();
      });

      li.appendChild(removeBtn);
      ul.appendChild(li);   // ✅ aqui é UL, não LIST
    });
  }


  btn.addEventListener("click", () => fileInput.click());

  fileInput.addEventListener("change", function () {
    const selected = Array.from(fileInput.files || []);
    if (selected.length === 0) return;

    for (const f of selected) {
      if (dt.files.length >= MAX_FILES) break;
      dt.items.add(f);
    }

    syncAndRender();
  });

  bindDropZone(multiZone, (files) => {
    for (const f of files) {
      if (dt.files.length >= MAX_FILES) break;
      dt.items.add(f);
    }
    syncAndRender();
  });

  render();
});
</script>

{% endblock %}

